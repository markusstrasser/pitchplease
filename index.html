<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PitchPlease</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Helvetica, system-ui, sans-serif;
      background: oklch(10% 0 0);
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      padding: 0.8rem;
      background: oklch(15% 0 0);
    }

    .chord-display {
      display: flex;
      align-items: baseline;
      padding: 0.4rem 1.2rem;
      border-radius: 6px;
      border: 1px solid oklch(30% 0 0);
      min-width: 100px;
      justify-content: center;
    }
    .chord-root {
      font-size: 2.2rem;
      font-weight: bold;
    }
    .chord-ext {
      font-size: 1.4rem;
      font-weight: normal;
      opacity: 0.9;
    }

    button {
      border: 0;
      outline: 0;
      padding: 0.6rem 1.5rem;
      font-size: 0.9rem;
      border-radius: 4px;
      cursor: pointer;
      background: oklch(90% 0.2 105);
      color: oklch(20% 0 0);
      font-weight: 500;
    }
    button:hover { background: oklch(93% 0.2 105); }

    #container {
      flex: 1;
      position: relative;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .overlay {
      position: absolute;
      inset: 0;
      background: oklch(5% 0 0 / 95%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .overlay.hidden { display: none; }
    .overlay button {
      padding: 1.2rem 2.5rem;
      font-size: 1.5rem;
      border-radius: 8px;
    }

    /* Dual range slider */
    .range-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .range-label {
      font-size: 0.85rem;
      min-width: 2.5rem;
      text-align: center;
      opacity: 0.8;
    }
    .dual-range {
      position: relative;
      width: 180px;
      height: 24px;
    }
    .dual-range input[type="range"] {
      position: absolute;
      width: 100%;
      height: 6px;
      top: 9px;
      pointer-events: none;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
    }
    .dual-range input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: oklch(90% 0.2 105);
      cursor: pointer;
      pointer-events: auto;
      border: 2px solid oklch(20% 0 0);
    }
    .dual-range input[type="range"]::-moz-range-thumb {
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: oklch(90% 0.2 105);
      cursor: pointer;
      pointer-events: auto;
      border: 2px solid oklch(20% 0 0);
    }
    .dual-range .track {
      position: absolute;
      height: 6px;
      top: 9px;
      left: 0;
      right: 0;
      background: oklch(30% 0 0);
      border-radius: 3px;
    }
    .dual-range .track-fill {
      position: absolute;
      height: 6px;
      top: 9px;
      background: oklch(55% 0.15 105);
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <div class="chord-display" id="chord">
      <span class="chord-root" id="root">-</span>
      <span class="chord-ext" id="ext"></span>
    </div>
    <div class="range-wrap">
      <span class="range-label" id="lowNote">C3</span>
      <div class="dual-range">
        <div class="track"></div>
        <div class="track-fill" id="trackFill"></div>
        <input type="range" id="lowRange" min="24" max="96" value="24">
        <input type="range" id="highRange" min="24" max="96" value="96">
      </div>
      <span class="range-label" id="highNote">C6</span>
    </div>
    <button id="pause">PAUSE [Space]</button>
    <button id="heightMode">FIXED</button>
  </header>

  <div id="container">
    <div class="overlay" id="overlay">
      <button id="start">Ready!</button>
    </div>
    <canvas id="c"></canvas>
  </div>

  <script src="pitchplease.js"></script>
  <script>
    const { create, midiToNote, NOTE_NAMES } = PitchPlease;

    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const chordEl = document.getElementById('chord');
    const rootEl = document.getElementById('root');
    const extEl = document.getElementById('ext');

    // Range slider
    const lowRange = document.getElementById('lowRange');
    const highRange = document.getElementById('highRange');
    const lowNote = document.getElementById('lowNote');
    const highNote = document.getElementById('highNote');
    const trackFill = document.getElementById('trackFill');

    let midiLow = 24, midiHigh = 96;

    function updateRange() {
      const lo = +lowRange.value, hi = +highRange.value;
      if (lo > hi - 12) { // min 1 octave span
        if (this === lowRange) lowRange.value = hi - 12;
        else highRange.value = lo + 12;
      }
      midiLow = +lowRange.value;
      midiHigh = +highRange.value;
      lowNote.textContent = midiToNote(midiLow, true);
      highNote.textContent = midiToNote(midiHigh, true);
      // Update fill bar
      const pct = v => (v - 24) / 72 * 100;
      trackFill.style.left = pct(midiLow) + '%';
      trackFill.style.right = (100 - pct(midiHigh)) + '%';
    }
    lowRange.oninput = updateRange;
    highRange.oninput = updateRange;
    updateRange();

    // Height mode toggle
    let absolute = true;
    const heightModeBtn = document.getElementById('heightMode');
    heightModeBtn.onclick = () => {
      absolute = !absolute;
      heightModeBtn.textContent = absolute ? 'FIXED' : 'AUTO';
    };

    // HSL color from pitch class (chromatic circle)
    function pcColor(pc, s = 80, l = 50, a = 1) {
      const h = (360 - pc * 30 + 60) % 360;
      return `hsla(${h},${s}%,${l}%,${a})`;
    }

    function resize() {
      canvas.width = canvas.clientWidth * devicePixelRatio;
      canvas.height = canvas.clientHeight * devicePixelRatio;
    }
    resize();
    window.onresize = resize;

    // State for stable display
    let lastNotesKey = '';
    let lastChord = null;
    let chordHoldFrames = 0;

    const p = create({
      onUpdate(d) {
        const w = canvas.width, h = canvas.height;
        const dpr = devicePixelRatio;

        // Clear
        ctx.fillStyle = 'oklch(8% 0 0)';
        ctx.fillRect(0, 0, w, h);

        // Draw spectrum bars (vivid colors by pitch class)
        const midiSpan = midiHigh - midiLow;
        const maxE = absolute ? 180 : d.maxEnergy; // 180 so typical voice ~80-90%
        for (let i = 0; i < d.spectrum.length; i++) {
          const midi = d.binMidi[i];
          if (midi < midiLow || midi > midiHigh) continue;
          const e = d.spectrum[i] / maxE;
          if (e < 0.02) continue;

          const x = (midi - midiLow) / midiSpan * w;
          const bh = e * h * 0.9;
          // Vivid colors: brightness follows energy
          ctx.fillStyle = pcColor(Math.round(midi) % 12, 70 + e * 20, 35 + e * 25, 0.95);
          ctx.fillRect(x, h - bh, Math.max(2, w / midiSpan / 2), bh);
        }

        // Draw detected note labels ON the spectrogram
        for (let i = 0; i < d.fundCount; i++) {
          const midi = Math.round(d.fundMidis[i]);
          if (midi < midiLow || midi > midiHigh) continue;

          // Find energy at this MIDI note
          let energy = 0;
          for (let j = 0; j < d.binMidi.length; j++) {
            if (Math.abs(d.binMidi[j] - midi) < 0.5) {
              energy = Math.max(energy, d.spectrum[j] / maxE);
            }
          }

          const x = (midi - midiLow) / midiSpan * w;
          const pc = midi % 12;
          const y = h - (h * energy) / 2;

          // Colored square - vivid
          const size = 55 * dpr;
          ctx.fillStyle = pcColor(pc, 85, 55, 0.9);
          ctx.fillRect(x - size/2, y - size/2, size, size);

          // Note name
          ctx.fillStyle = 'white';
          ctx.font = `bold ${26 * dpr}px Helvetica`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(midiToNote(midi, false), x, y);
        }

        // Stability indicator
        if (d.stable) {
          ctx.fillStyle = 'hsla(120, 60%, 50%, 0.4)';
          ctx.fillRect(0, h - 4, w, 4);
        }

        // Update chord display (with hold)
        if (d.chord && d.stable) {
          lastChord = d.chord;
          chordHoldFrames = 60;
        }

        if (chordHoldFrames > 0) {
          chordHoldFrames--;
          if (lastChord) {
            rootEl.textContent = lastChord.root;
            extEl.textContent = lastChord.abbrev;
            chordEl.style.background = pcColor(lastChord.rootPc, 80, 40, 0.9);
          }
        } else {
          rootEl.textContent = '-';
          extEl.textContent = '';
          chordEl.style.background = 'transparent';
        }
      },

      onError(e) { alert(e.message); }
    });

    document.getElementById('start').onclick = async () => {
      document.getElementById('overlay').classList.add('hidden');
      await p.start();
    };

    const pauseBtn = document.getElementById('pause');
    function togglePause() {
      const paused = p.togglePause();
      pauseBtn.textContent = paused ? 'RESUME [Space]' : 'PAUSE [Space]';
    }

    pauseBtn.onclick = togglePause;
    document.onkeydown = e => {
      if (e.code === 'Space') { e.preventDefault(); togglePause(); }
    };
  </script>
</body>
</html>
